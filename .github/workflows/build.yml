name: Build and Push Snell Docker Image

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Snellç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š5.0.1 æˆ– v5.0.1ï¼Œç•™ç©ºä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼‰'
        required: false
        type: string
      debian_version:
        description: 'Debianç‰ˆæœ¬å·ï¼ˆå¦‚ï¼šbookworm, stable, testingï¼Œç•™ç©ºä½¿ç”¨ stableï¼‰'
        required: false
        type: string
      force:
        description: 'å¼ºåˆ¶æ„å»ºï¼ˆå³ä½¿ç‰ˆæœ¬å·²å­˜åœ¨ï¼‰'
        required: false
        type: boolean
        default: false

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      should_build: ${{ steps.check_build.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: è·å– Snell æœ€æ–°ç‰ˆæœ¬ï¼ˆå¸¦é‡è¯•ï¼‰
        id: get_version
        run: |
          # è·å–å®˜æ–¹æœ€æ–°ç‰ˆæœ¬çš„å‡½æ•°ï¼ˆå¸¦é‡è¯•ï¼‰
          get_official_version() {
            local max_retries=3
            local retry_delay=5
            local attempt=1
            
            while [ $attempt -le $max_retries ]; do
              echo "â†’ å°è¯•è·å–å®˜æ–¹ç‰ˆæœ¬ (ç¬¬ $attempt æ¬¡)..."
              
              LATEST_VERSION=$(curl -sL --connect-timeout 10 --max-time 30 \
                https://kb.nssurge.com/surge-knowledge-base/zh/release-notes/snell | \
                grep -oP 'snell-server-v\K[0-9]+\.[0-9]+\.[0-9]+' | \
                sort -Vru | head -n 1)
              
              # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–ä¸”ä¸æ˜¯ 0.0.0
              if [ -n "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "0.0.0" ]; then
                echo "âœ“ æˆåŠŸè·å–å®˜æ–¹ç‰ˆæœ¬: v${LATEST_VERSION}"
                echo "$LATEST_VERSION"
                return 0
              fi
              
              echo "âš ï¸ è·å–å¤±è´¥æˆ–ç‰ˆæœ¬å¼‚å¸¸: ${LATEST_VERSION:-ç©º}"
              
              if [ $attempt -lt $max_retries ]; then
                echo "â†’ ç­‰å¾… ${retry_delay} ç§’åé‡è¯•..."
                sleep $retry_delay
              fi
              
              attempt=$((attempt + 1))
            done
            
            echo "âœ— é‡è¯• $max_retries æ¬¡åä»ç„¶å¤±è´¥"
            return 1
          }
          
          # å¦‚æœç”¨æˆ·æŒ‡å®šäº†ç‰ˆæœ¬ï¼Œç›´æ¥ä½¿ç”¨
          if [ -n "${{ inputs.version }}" ]; then
            INPUT_VERSION="${{ inputs.version }}"
            VERSION_NUM="${INPUT_VERSION#v}"
            VERSION="v${VERSION_NUM}"
            echo "âœ“ ä½¿ç”¨ç”¨æˆ·æŒ‡å®šç‰ˆæœ¬: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # è·å–å®˜æ–¹æœ€æ–°ç‰ˆæœ¬
          OFFICIAL_VERSION=$(get_official_version)
          if [ $? -ne 0 ] || [ -z "$OFFICIAL_VERSION" ]; then
            echo "âœ— æ— æ³•è·å–å®˜æ–¹ç‰ˆæœ¬å·ï¼Œæ„å»ºç»ˆæ­¢"
            exit 1
          fi
          
          VERSION="v${OFFICIAL_VERSION}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ å®˜æ–¹æœ€æ–°ç‰ˆæœ¬: $VERSION"

      - name: è·å– GHCR æœ€æ–°ç‰ˆæœ¬ï¼ˆå¸¦é‡è¯•ï¼‰
        id: get_ghcr_version
        run: |
          get_ghcr_version() {
            local max_retries=3
            local retry_delay=5
            local attempt=1
            
            while [ $attempt -le $max_retries ]; do
              echo "â†’ å°è¯•è·å– GHCR ç‰ˆæœ¬ (ç¬¬ $attempt æ¬¡)..."
              
              GHCR_VERSION=$(curl -sL --connect-timeout 10 --max-time 30 \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/users/${{ github.repository_owner }}/packages/container/snell/versions" | \
                grep -oP '"name":\s*"\Kv[0-9]+\.[0-9]+\.[0-9]+' | \
                sort -Vru | head -n 1)
              
              if [ -n "$GHCR_VERSION" ]; then
                echo "âœ“ æˆåŠŸè·å– GHCR ç‰ˆæœ¬: ${GHCR_VERSION}"
                echo "$GHCR_VERSION"
                return 0
              fi
              
              echo "âš ï¸ è·å–å¤±è´¥"
              
              if [ $attempt -lt $max_retries ]; then
                echo "â†’ ç­‰å¾… ${retry_delay} ç§’åé‡è¯•..."
                sleep $retry_delay
              fi
              
              attempt=$((attempt + 1))
            done
            
            # å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å› v0.0.0 è¡¨ç¤ºæ²¡æœ‰ç°æœ‰ç‰ˆæœ¬
            echo "âš ï¸ æ— æ³•è·å– GHCR ç‰ˆæœ¬ï¼Œå‡è®¾ä¸å­˜åœ¨"
            echo "v0.0.0"
            return 0
          }
          
          GHCR_VERSION=$(get_ghcr_version)
          echo "ghcr_version=$GHCR_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ GHCR å½“å‰ç‰ˆæœ¬: $GHCR_VERSION"

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          OFFICIAL_VERSION="${{ steps.get_version.outputs.version }}"
          GHCR_VERSION="${{ steps.get_ghcr_version.outputs.ghcr_version }}"
          FORCE="${{ inputs.force }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ç‰ˆæœ¬å¯¹æ¯”:"
          echo "  å®˜æ–¹ç‰ˆæœ¬: $OFFICIAL_VERSION"
          echo "  GHCRç‰ˆæœ¬: $GHCR_VERSION"
          echo "  å¼ºåˆ¶æ„å»º: $FORCE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # å¼ºåˆ¶æ„å»ºæ¨¡å¼
          if [ "$FORCE" = "true" ]; then
            echo "âœ“ å¼ºåˆ¶æ„å»ºæ¨¡å¼å·²å¯ç”¨"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ç§»é™¤ v å‰ç¼€ç”¨äºæ¯”è¾ƒ
          OFFICIAL_NUM="${OFFICIAL_VERSION#v}"
          GHCR_NUM="${GHCR_VERSION#v}"
          
          # ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°
          version_gt() {
            test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
          }
          
          # å¦‚æœ GHCR ç‰ˆæœ¬æ˜¯ 0.0.0ï¼Œè¯´æ˜ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º
          if [ "$GHCR_NUM" = "0.0.0" ]; then
            echo "âœ“ GHCR ä¸­æ— ç°æœ‰ç‰ˆæœ¬ï¼Œéœ€è¦æ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ¯”è¾ƒç‰ˆæœ¬å·
          if version_gt "$OFFICIAL_NUM" "$GHCR_NUM"; then
            echo "âœ“ å®˜æ–¹ç‰ˆæœ¬ ($OFFICIAL_VERSION) å¤§äº GHCR ç‰ˆæœ¬ ($GHCR_VERSION)ï¼Œéœ€è¦æ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "â†’ å®˜æ–¹ç‰ˆæœ¬ ($OFFICIAL_VERSION) ä¸å¤§äº GHCR ç‰ˆæœ¬ ($GHCR_VERSION)ï¼Œæ— éœ€æ„å»º"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: env.DOCKER_HUB_USERNAME != '' && env.DOCKER_HUB_TOKEN != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡ Docker Hub ä»“åº“
        if: env.DOCKER_HUB_USERNAME != '' && env.DOCKER_HUB_TOKEN != ''
        continue-on-error: true
        run: |
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          echo "â†’ æ£€æŸ¥ Docker Hub ä»“åº“: ${REPO_NAME}"
          
          # æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.DOCKER_HUB_TOKEN }}" \
            "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_HUB_USERNAME }}/${REPO_NAME}/")
          
          if [ "$RESPONSE" = "404" ]; then
            echo "â†’ ä»“åº“ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º..."
            
            CREATE_RESPONSE=$(curl -s -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.DOCKER_HUB_TOKEN }}" \
              -d "{
                \"name\": \"${REPO_NAME}\",
                \"description\": \"Multi-architecture Snell Server - Supports amd64, 386, arm64, armv7\",
                \"is_private\": false
              }" \
              "https://hub.docker.com/v2/repositories/")
            
            if echo "$CREATE_RESPONSE" | grep -q '"name"'; then
              echo "âœ“ Docker Hub ä»“åº“åˆ›å»ºæˆåŠŸ"
            else
              echo "âš ï¸ Docker Hub ä»“åº“åˆ›å»ºå¤±è´¥ï¼ˆå¯èƒ½å·²å­˜åœ¨æˆ–æƒé™ä¸è¶³ï¼‰"
              echo "Response: $CREATE_RESPONSE"
            fi
          else
            echo "âœ“ Docker Hub ä»“åº“å·²å­˜åœ¨"
          fi

      - name: å‡†å¤‡æ„å»ºå‚æ•°
        id: prep
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          
          if [ -n "${{ inputs.debian_version }}" ]; then
            DEBIAN_VERSION="${{ inputs.debian_version }}"
          else
            DEBIAN_VERSION="stable"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "debian_version=$DEBIAN_VERSION" >> $GITHUB_OUTPUT
          
          GHCR_IMAGE="ghcr.io/${{ github.repository_owner }}/${REPO_NAME}"
          TAGS="${GHCR_IMAGE}:${VERSION},${GHCR_IMAGE}:latest"
          
          if [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
            DOCKER_HUB_IMAGE="${{ secrets.DOCKER_HUB_USERNAME }}/${REPO_NAME}"
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:${VERSION},${DOCKER_HUB_IMAGE}:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "vcs_ref=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“¦ æ„å»ºä¿¡æ¯:"
          echo "  åŸºç¡€é•œåƒ: debian:$DEBIAN_VERSION"
          echo "  Snell ç‰ˆæœ¬: $VERSION"
          echo "  æ ‡ç­¾: $TAGS"

      - name: åˆ›å»ºç©º Version ç›®å½•
        run: |
          mkdir -p Version
          touch Version/.gitkeep

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/386,linux/arm64,linux/arm/v7
          push: true
          tags: ${{ steps.prep.outputs.tags }}
          build-args: |
            SNELL_VERSION=${{ steps.prep.outputs.version }}
            BASE_VERSION=${{ steps.prep.outputs.debian_version }}
            BUILD_DATE=${{ steps.prep.outputs.build_date }}
            VCS_REF=${{ steps.prep.outputs.vcs_ref }}
          labels: |
            org.opencontainers.image.title=Snell Server
            org.opencontainers.image.description=Multi-architecture Snell Server - Supports amd64, 386, arm64, armv7
            org.opencontainers.image.version=${{ steps.prep.outputs.version }}
            org.opencontainers.image.created=${{ steps.prep.outputs.build_date }}
            org.opencontainers.image.revision=${{ steps.prep.outputs.vcs_ref }}
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}#readme
            org.opencontainers.image.vendor=${{ github.repository_owner }}
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: æ›´æ–° GHCR åŒ…æè¿°
        if: success()
        continue-on-error: true
        run: |
          sleep 5
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          echo "â†’ æ›´æ–° GHCR åŒ…æè¿°..."
          
          DESCRIPTION="Multi-arch Snell Server ${{ steps.prep.outputs.version }}. Platforms: amd64, 386, arm64, armv7. Docs: https://github.com/${{ github.repository }}"
          
          curl -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user/packages/container/${REPO_NAME}" \
            -d "{\"description\":\"${DESCRIPTION}\"}" \
            && echo "âœ“ GHCR æè¿°å·²æ›´æ–°" \
            || echo "âš ï¸ GHCR æè¿°æ›´æ–°å¤±è´¥ï¼ˆä¸å½±å“æ„å»ºï¼‰"
      
      - name: æ›´æ–° Docker Hub ä»“åº“æè¿°
        if: success() && env.DOCKER_HUB_USERNAME != '' && env.DOCKER_HUB_TOKEN != ''
        continue-on-error: true
        run: |
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          echo "â†’ æ›´æ–° Docker Hub ä»“åº“æè¿°..."
          
          FULL_DESCRIPTION="# Snell Server Docker Image

Multi-architecture Snell Server supporting amd64, 386, arm64, and armv7 platforms.

## Version: ${{ steps.prep.outputs.version }}

For documentation and usage examples, visit: https://github.com/${{ github.repository }}"
          
          curl -X PATCH \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DOCKER_HUB_TOKEN }}" \
            -d "{
              \"description\": \"Multi-arch Snell Server ${{ steps.prep.outputs.version }} - amd64, 386, arm64, armv7\",
              \"full_description\": $(echo "$FULL_DESCRIPTION" | jq -Rs .)
            }" \
            "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_HUB_USERNAME }}/${REPO_NAME}/" \
            && echo "âœ“ Docker Hub æè¿°å·²æ›´æ–°" \
            || echo "âš ï¸ Docker Hub æè¿°æ›´æ–°å¤±è´¥ï¼ˆä¸å½±å“æ„å»ºï¼‰"
