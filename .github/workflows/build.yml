name: Build and Push Snell Docker Image

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Snell版本 (如 4.0.1, 留空自动获取)'
        required: false
        type: string
      debian_version:
        description: 'Debian 标签 (如 12-slim, stable-slim)'
        required: false
        default: 'stable-slim'
        type: string
      force:
        description: '强制构建'
        required: false
        type: boolean
        default: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_build: ${{ steps.decide.outputs.should_build }}
      debian_tag: ${{ steps.debian.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: 确定 Debian 版本
        id: debian
        run: echo "tag=${{ github.event.inputs.debian_version || 'stable-slim' }}" >> $GITHUB_OUTPUT

      - name: 获取 Snell 官方版本 (带重试)
        id: version
        run: |
          for i in {1..5}; do
            VERSION=$(curl -fsSL https://kb.nssurge.com/surge-knowledge-base/zh/release-notes/snell \
              | grep -oP 'snell-server-v\K[0-9]+\.[0-9]+\.[0-9]+' \
              | sort -V | tail -n1)
            [ -n "$VERSION" ] && break || sleep 10
          done
          
          if [ -n "${{ github.event.inputs.version }}" ]; then
            V_INPUT="${{ github.event.inputs.version }}"
            echo "version=v${V_INPUT#v}" >> $GITHUB_OUTPUT
          else
            [ -z "$VERSION" ] && exit 1
            echo "version=v$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: 获取 GHCR 现有版本
        id: ghcr
        run: |
          TOKEN=$(curl -fsSL "https://ghcr.io/token?scope=repository:${{ github.repository_owner }}/snell:pull" | jq -r '.token // empty')
          GHCR_V="v0.0.0"
          if [ -n "$TOKEN" ]; then
            GHCR_V=$(curl -fsSL -H "Authorization: Bearer $TOKEN" https://ghcr.io/v2/${{ github.repository_owner }}/snell/tags/list \
              | jq -r '.tags[]?' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || echo "v0.0.0")
          fi
          echo "ghcr_version=$GHCR_V" >> $GITHUB_OUTPUT

      - name: 版本比对与决策
        id: decide
        run: |
          OFFICIAL="${{ steps.version.outputs.version }}"
          CURRENT="${{ steps.ghcr.outputs.ghcr_version }}"
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "$OFFICIAL" != "$CURRENT" ]; then
            HIGHEST=$(printf '%s\n%s' "$OFFICIAL" "$CURRENT" | sort -V | tail -n1)
            [ "$HIGHEST" == "$OFFICIAL" ] && echo "should_build=true" >> $GITHUB_OUTPUT || echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        # 修复：通过 env 变量来检查
        if: github.repository_owner == '你的Github用户名' || env.DOCKER_HUB_TOKEN != ''
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ env.DOCKER_HUB_TOKEN }}

      - name: 自动创建 Docker Hub 仓库 (如果不存在)
        if: env.DOCKER_HUB_TOKEN != ''
        run: |
          REPO_NAME="snell"
          USER="${{ env.DOCKER_HUB_USERNAME }}"
          TOKEN="${{ env.DOCKER_HUB_TOKEN }}"
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -u "$USER:$TOKEN" "https://hub.docker.com/v2/repositories/$USER/$REPO_NAME/")
          
          if [ "$HTTP_STATUS" -eq 404 ]; then
            echo "仓库 $USER/$REPO_NAME 不存在，正在创建..."
            curl -s -X POST -u "$USER:$TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"$REPO_NAME\",\"is_private\":false,\"description\":\"Snell Server Docker Image\"}" \
              "https://hub.docker.com/v2/repositories/$USER/"
          else
            echo "仓库 $USER/$REPO_NAME 已存在。"
          fi

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/386,linux/arm64,linux/arm/v7
          build-args: |
            SNELL_VERSION=${{ needs.check-version.outputs.version }}
            BASE_TAG=${{ needs.check-version.outputs.debian_tag }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/snell:${{ needs.check-version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/snell:latest
            ${{ env.DOCKER_HUB_USERNAME != '' && format('{0}/snell:{1}', env.DOCKER_HUB_USERNAME, needs.check-version.outputs.version) || '' }}
            ${{ env.DOCKER_HUB_USERNAME != '' && format('{0}/snell:latest', env.DOCKER_HUB_USERNAME) || '' }}