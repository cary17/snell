name: Build and Push Snell Docker Image

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Snell版本 (如 4.0.1, 留空自动获取最新)'
        required: false
        type: string
      debian_version:
        description: 'Debian 标签 (默认 stable-slim)'
        required: false
        default: 'stable-slim'
        type: string
      force:
        description: '强制构建'
        required: false
        type: boolean
        default: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_build: ${{ steps.decide.outputs.should_build }}
      debian_tag: ${{ steps.debian.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: 确定 Debian 版本
        id: debian
        run: echo "tag=${{ github.event.inputs.debian_version || 'stable-slim' }}" >> $GITHUB_OUTPUT

      - name: 获取 Snell 官方版本 (带重试机制)
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            V_INPUT="${{ github.event.inputs.version }}"
            echo "version=v${V_INPUT#v}" >> $GITHUB_OUTPUT
          else
            # 重试 3 次获取版本
            for i in {1..3}; do
              VERSION=$(curl -fsSL https://kb.nssurge.com/surge-knowledge-base/zh/release-notes/snell \
                | grep -oP 'snell-server-v\K[0-9]+\.[0-9]+\.[0-9]+' \
                | sort -V | tail -n1)
              [ -n "$VERSION" ] && break || sleep 5
            done
            if [ -z "$VERSION" ]; then echo "获取官方版本失败" && exit 1; fi
            echo "version=v$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: 获取 GHCR 现有最新版本
        id: ghcr
        run: |
          TOKEN=$(curl -fsSL "https://ghcr.io/token?scope=repository:${{ github.repository_owner }}/snell:pull" | jq -r '.token // empty')
          if [ -n "$TOKEN" ]; then
            GHCR_V=$(curl -fsSL -H "Authorization: Bearer $TOKEN" https://ghcr.io/v2/${{ github.repository_owner }}/snell/tags/list \
              | jq -r '.tags[]?' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || echo "v0.0.0")
          else
            GHCR_V="v0.0.0"
          fi
          echo "ghcr_version=$GHCR_V" >> $GITHUB_OUTPUT

      - name: 判断是否需要构建
        id: decide
        run: |
          OFFICIAL="${{ steps.version.outputs.version }}"
          CURRENT="${{ steps.ghcr.outputs.ghcr_version }}"
          echo "官方版本: $OFFICIAL, 当前版本: $CURRENT"
          
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "$OFFICIAL" != "$CURRENT" ]; then
            # 只有当官方版本高于当前版本时才构建
            HIGHEST=$(printf '%s\n%s' "$OFFICIAL" "$CURRENT" | sort -V | tail -n1)
            if [ "$HIGHEST" == "$OFFICIAL" ]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/386,linux/arm64,linux/arm/v7
          build-args: |
            SNELL_VERSION=${{ needs.check-version.outputs.version }}
            BASE_TAG=${{ needs.check-version.outputs.debian_tag }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/snell:${{ needs.check-version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/snell:latest
