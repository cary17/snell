name: Build and Push Snell Docker Image

on:
  schedule:
    # 北京时间每个整点执行（UTC 时间每个整点）
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Snell版本号（如：5.0.1 或 v5.0.1，留空使用最新版本）'
        required: false
        type: string
      debian_version:
        description: 'Debian版本号（如：bookworm, stable, testing，留空使用 stable）'
        required: false
        type: string
      force:
        description: '强制构建（即使版本已存在）'
        required: false
        type: boolean
        default: false

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  GHCR_USERNAME: ${{ github.repository_owner }}

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      should_build: ${{ steps.check_build.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 获取 Snell 版本
        id: get_version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            INPUT_VERSION="${{ inputs.version }}"
            # 统一处理：去掉 v 前缀后再加上
            VERSION_NUM="${INPUT_VERSION#v}"
            VERSION="v${VERSION_NUM}"
            echo "✓ 使用指定版本: $VERSION"
          else
            echo "→ 检测最新版本..."
            # 从官方 Release Notes 页面提取最新版本
            LATEST_VERSION=$(curl -sL https://kb.nssurge.com/surge-knowledge-base/zh/release-notes/snell | \
              grep -oP 'snell-server-v\K[0-9]+\.[0-9]+\.[0-9]+' | \
              sort -Vru | head -n 1)
            
            if [ -z "$LATEST_VERSION" ]; then
              echo "✗ 无法从官网获取版本号"
              exit 1
            fi
            
            VERSION="v${LATEST_VERSION}"
            echo "✓ 检测到最新版本: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "📌 最终版本号: $VERSION"

      - name: 检查是否需要构建
        id: check_build
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          FORCE="${{ inputs.force }}"
          
          if [ "$FORCE" = "true" ]; then
            echo "✓ 强制构建模式"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 检查 GHCR 是否已存在该版本
          if docker manifest inspect ghcr.io/${{ github.repository_owner }}/snell:${VERSION} >/dev/null 2>&1; then
            echo "→ 版本 ${VERSION} 已存在于 GHCR"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "✓ 版本 ${VERSION} 需要构建"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: env.DOCKER_HUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 准备构建参数
        id: prep
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          
          # 确定 Debian 基础镜像版本
          if [ -n "${{ inputs.debian_version }}" ]; then
            DEBIAN_VERSION="${{ inputs.debian_version }}"
          else
            DEBIAN_VERSION="stable"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "debian_version=$DEBIAN_VERSION" >> $GITHUB_OUTPUT
          
          # 构建镜像标签
          GHCR_IMAGE="ghcr.io/${{ github.repository_owner }}/snell"
          
          # 默认标签：version 和 latest
          TAGS="${GHCR_IMAGE}:${VERSION},${GHCR_IMAGE}:latest"
          
          # 如果配置了 Docker Hub
          if [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            DOCKER_HUB_IMAGE="${{ secrets.DOCKER_HUB_USERNAME }}/snell"
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:${VERSION},${DOCKER_HUB_IMAGE}:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          
          # 构建日期和 Git commit
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "vcs_ref=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          
          echo ""
          echo "📦 构建信息:"
          echo "  基础镜像: debian:$DEBIAN_VERSION"
          echo "  Snell 版本: $VERSION"
          echo "  标签: $TAGS"

      - name: 创建空 Version 目录
        run: |
          mkdir -p Version
          touch Version/.gitkeep

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/386,linux/arm64,linux/arm/v7
          push: true
          tags: ${{ steps.prep.outputs.tags }}
          build-args: |
            SNELL_VERSION=${{ steps.prep.outputs.version }}
            BASE_VERSION=${{ steps.prep.outputs.debian_version }}
            BUILD_DATE=${{ steps.prep.outputs.build_date }}
            VCS_REF=${{ steps.prep.outputs.vcs_ref }}
          labels: |
            org.opencontainers.image.title=Snell Server
            org.opencontainers.image.description=Multi-architecture Snell Server - Supports amd64, 386, arm64, armv7
            org.opencontainers.image.version=${{ steps.prep.outputs.version }}
            org.opencontainers.image.created=${{ steps.prep.outputs.build_date }}
            org.opencontainers.image.revision=${{ steps.prep.outputs.vcs_ref }}
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}#readme
            org.opencontainers.image.vendor=${{ github.repository_owner }}
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 构建摘要
        run: |
          echo "### ✅ 构建完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Snell 版本:** ${{ steps.prep.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Debian 版本:** ${{ steps.prep.outputs.debian_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**构建日期:** ${{ steps.prep.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Git Commit:** ${{ steps.prep.outputs.vcs_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**支持架构:** linux/amd64, linux/386, linux/arm64, linux/arm/v7" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**镜像标签:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.prep.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
```

## 使用说明

1. **替换占位符**：
   - 将所有 `OWNER` 替换为你的 GitHub 用户名
   - 将所有 `REPO` 替换为你的仓库名

2. **文件结构**：
```
   your-repo/
   ├── .dockerignore          # 新增
   ├── .github/
   │   └── workflows/
   │       └── build.yml      # 更新
   ├── Dockerfile             # 更新
   ├── entrypoint.sh
   ├── README.md              # 完整文档（不会显示在 GHCR）
   ├── README.ghcr.md         # 新增（GHCR 简介）
   └── Version/
