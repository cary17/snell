name: Build and Push Snell Docker Image

on:
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ–°ç‰ˆæœ¬
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Snellç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š5.0.1ï¼Œç•™ç©ºä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼‰'
        required: false
        type: string
      debian:
        description: 'Debianç‰ˆæœ¬ï¼ˆå¦‚ï¼šbookworm, bullseye, trixieï¼‰'
        required: false
        default: 'bookworm'
        type: string
      use_repo_files:
        description: 'ä½¿ç”¨ä»“åº“ä¸­çš„ Version ç›®å½•æ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰'
        required: false
        type: boolean
        default: false
      force:
        description: 'å¼ºåˆ¶æž„å»ºï¼ˆå³ä½¿ç‰ˆæœ¬å·²å­˜åœ¨ï¼‰'
        required: false
        type: boolean
        default: false

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  GHCR_USERNAME: ${{ github.repository_owner }}

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      should_build: ${{ steps.check_build.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: èŽ·å– Snell ç‰ˆæœ¬
        id: get_version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "âœ“ ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬: $VERSION"
          else
            echo "â†’ æ£€æµ‹æœ€æ–°ç‰ˆæœ¬..."
            # æ–¹æ³•1: ä»Ž Release Notes é¡µé¢æå–
            VERSION=$(curl -sL https://kb.nssurge.com/surge-knowledge-base/zh/release-notes/snell | \
              grep -oP 'snell-server-v\K[0-9]+\.[0-9]+\.[0-9]+' | \
              sort -Vru | head -n 1)
            
            # æ–¹æ³•2: å¦‚æžœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•è§£æžä¸‹è½½é¡µé¢
            if [ -z "$VERSION" ]; then
              VERSION=$(curl -sL https://dl.nssurge.com/snell/ 2>/dev/null | \
                grep -oP 'snell-server-v\K[0-9]+\.[0-9]+\.[0-9]+' | \
                sort -Vru | head -n 1)
            fi
            
            if [ -z "$VERSION" ]; then
              echo "âœ— æ— æ³•èŽ·å–ç‰ˆæœ¬å·"
              exit 1
            fi
            echo "âœ“ æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ä»“åº“ä¸­æ˜¯å¦æœ‰è¯¥ç‰ˆæœ¬çš„æ–‡ä»¶
        id: check_repo_files
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          USE_REPO="${{ inputs.use_repo_files }}"
          
          if [ "$USE_REPO" = "true" ] || [ -z "$USE_REPO" ]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰è‡³å°‘ä¸€ä¸ªå¹³å°çš„æ–‡ä»¶
            if ls Version/${VERSION}/snell-server-v${VERSION}-linux-*.zip 1> /dev/null 2>&1; then
              echo "âœ“ ä»“åº“ä¸­å­˜åœ¨ç‰ˆæœ¬ ${VERSION} çš„æ–‡ä»¶"
              echo "has_files=true" >> $GITHUB_OUTPUT
            else
              echo "â†’ ä»“åº“ä¸­ä¸å­˜åœ¨ç‰ˆæœ¬ ${VERSION} çš„æ–‡ä»¶"
              echo "has_files=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â†’ ä¸ä½¿ç”¨ä»“åº“æ–‡ä»¶"
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æž„å»º
        id: check_build
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          FORCE="${{ inputs.force }}"
          
          if [ "$FORCE" = "true" ]; then
            echo "âœ“ å¼ºåˆ¶æž„å»ºæ¨¡å¼"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥ GHCR æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬
          if docker manifest inspect ghcr.io/${{ github.repository_owner }}/snell:$VERSION >/dev/null 2>&1; then
            echo "â†’ ç‰ˆæœ¬ $VERSION å·²å­˜åœ¨äºŽ GHCR"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "âœ“ ç‰ˆæœ¬ $VERSION éœ€è¦æž„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          # ç¡®ä¿èŽ·å–å®Œæ•´çš„ä»“åº“å†…å®¹ï¼ŒåŒ…æ‹¬ Version ç›®å½•
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: env.DOCKER_HUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡æž„å»ºå‚æ•°
        id: prep
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          DEBIAN="${{ inputs.debian || 'bookworm' }}"
          USE_REPO="${{ inputs.use_repo_files }}"
          
          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ä»“åº“æ–‡ä»¶
          if [ "$USE_REPO" = "true" ]; then
            if ls Version/${VERSION}/snell-server-v${VERSION}-linux-*.zip 1> /dev/null 2>&1; then
              USE_LOCAL="true"
              echo "âœ“ å°†ä½¿ç”¨ä»“åº“ä¸­çš„æ–‡ä»¶"
            else
              USE_LOCAL="false"
              echo "â†’ ä»“åº“ä¸­æ— æ–‡ä»¶ï¼Œå°†ä»Žå®˜æ–¹ä¸‹è½½"
            fi
          else
            USE_LOCAL="false"
            echo "â†’ å°†ä»Žå®˜æ–¹ä¸‹è½½"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "debian=$DEBIAN" >> $GITHUB_OUTPUT
          echo "use_local=$USE_LOCAL" >> $GITHUB_OUTPUT
          
          # æž„å»ºé•œåƒæ ‡ç­¾
          GHCR_IMAGE="ghcr.io/${{ github.repository_owner }}/snell"
          TAGS="${GHCR_IMAGE}:${VERSION},${GHCR_IMAGE}:latest"
          
          # å¦‚æžœé…ç½®äº† Docker Hub
          if [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            DOCKER_HUB_IMAGE="${{ secrets.DOCKER_HUB_USERNAME }}/snell"
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:${VERSION},${DOCKER_HUB_IMAGE}:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“¦ æž„å»ºä¿¡æ¯:"
          echo "  ç‰ˆæœ¬: $VERSION"
          echo "  Debian: $DEBIAN"
          echo "  ä½¿ç”¨ä»“åº“æ–‡ä»¶: $USE_LOCAL"
          echo "  æ ‡ç­¾: $TAGS"

      - name: åˆ›å»ºç©º Version ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        run: |
          mkdir -p Version
          # åˆ›å»ºä¸€ä¸ªç©ºçš„ .gitkeep æ–‡ä»¶
          touch Version/.gitkeep

      - name: åˆ—å‡º Version ç›®å½•å†…å®¹
        run: |
          echo "â†’ Version ç›®å½•å†…å®¹:"
          ls -lhR Version/ || echo "  (ç›®å½•ä¸ºç©º)"

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/386,linux/arm64,linux/arm/v7
          push: true
          tags: ${{ steps.prep.outputs.tags }}
          build-args: |
            SNELL_VERSION=${{ steps.prep.outputs.version }}
            DEBIAN_VERSION=${{ steps.prep.outputs.debian }}
            USE_LOCAL=${{ steps.prep.outputs.use_local }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.prep.outputs.version }}
          name: Snell v${{ steps.prep.outputs.version }}
          body: |
            ## ðŸš€ Snell Server v${{ steps.prep.outputs.version }}
            
            **åŸºç¡€é•œåƒ:** Debian ${{ steps.prep.outputs.debian }}
            **æž„å»ºæ–¹å¼:** ${{ steps.prep.outputs.use_local == 'true' && 'ä½¿ç”¨ä»“åº“æ–‡ä»¶' || 'å®˜æ–¹ä¸‹è½½' }}
            
            ### ðŸ“¦ é•œåƒåœ°å€
            
            **GitHub Container Registry:**
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/snell:${{ steps.prep.outputs.version }}
            docker pull ghcr.io/${{ github.repository_owner }}/snell:latest
            ```
            
            **Docker Hub:** ${{ secrets.DOCKER_HUB_USERNAME != '' && format('
            ```bash
            docker pull {0}/snell:{1}
            docker pull {0}/snell:latest
            ```', secrets.DOCKER_HUB_USERNAME, steps.prep.outputs.version) || 'ï¼ˆæœªé…ç½®ï¼‰' }}
            
            ### ðŸ—ï¸ æ”¯æŒå¹³å°
            - `linux/amd64` - x86_64
            - `linux/386` - x86 (32-bit)  
            - `linux/arm64` - ARM64/aarch64
            - `linux/arm/v7` - ARMv7
            
            ### ðŸ“š å¿«é€Ÿå¼€å§‹
            
            ```bash
            docker run -d \
              --name Snell \
              --restart always \
              --network host \
              -e PORT=26615 \
              -e PSK="your_psk_here" \
              ghcr.io/${{ github.repository_owner }}/snell:${{ steps.prep.outputs.version }}
            ```
            
            ### âš ï¸ é‡è¦æç¤º
            
            - ðŸ”‘ **å¿…é¡»ä¿®æ”¹ PSK**: è¯·ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²
            - ðŸ”§ **egress-interface**: éœ€è¦ root æƒé™æˆ– CAP_NET_RAW/CAP_NET_ADMIN
            - ðŸ“ **é…ç½®è¯´æ˜Ž**: æŸ¥çœ‹ä»“åº“ README.md
            
            ### ðŸ”— ç›¸å…³é“¾æŽ¥
            - [Snell Release Notes](https://kb.nssurge.com/surge-knowledge-base/zh/release-notes/snell)
            - [é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }})
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "### âœ… æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ steps.prep.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Debian:** ${{ steps.prep.outputs.debian }}" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºæ–¹å¼:** ${{ steps.prep.outputs.use_local == 'true' && 'ä½¿ç”¨ä»“åº“æ–‡ä»¶' || 'å®˜æ–¹ä¸‹è½½' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.prep.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
